
{% extends "admin/admin_base.html" %}

{% block title %}Backup & Restore - DigitalSkeleton{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-database me-2"></i>Backup & Restore</h2>
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary">Back to Dashboard</a>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-download me-2"></i>Create Backup</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Create a complete backup of all data including:</p>
                    <ul>
                        <li>All database records (users, settings, ads, tutorials)</li>
                        <li>Generated package files</li>
                        <li>Static assets and templates</li>
                        <li>Application configuration</li>
                    </ul>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> The backup will include all sensitive data. Store it securely.
                    </div>
                    <form method="POST" action="{{ url_for('create_backup') }}" onsubmit="showBackupProgress(this)">
                        <button type="submit" class="btn btn-primary btn-lg" id="backupBtn">
                            <i class="fas fa-download me-2"></i>Create Full Backup
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Restore from Backup</h5>
                </div>
                <div class="card-body">
                    <p class="card-text">Restore the system from a previous backup:</p>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will completely replace all current data with the backup data. This action cannot be undone!
                    </div>
                    <form method="POST" action="{{ url_for('restore_backup') }}" enctype="multipart/form-data" onsubmit="return confirmRestore(this)">
                        <div class="mb-3">
                            <label for="backup_file" class="form-label">Select Backup File (.zip)</label>
                            <input type="file" class="form-control" id="backup_file" name="backup_file" accept=".zip" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirm_restore" required>
                            <label class="form-check-label text-danger" for="confirm_restore">
                                I understand that this will replace ALL current data and cannot be undone
                            </label>
                        </div>
                        <button type="submit" class="btn btn-warning btn-lg" id="restoreBtn">
                            <i class="fas fa-upload me-2"></i>Restore from Backup
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Backup Information</h5>
        </div>
        <div class="card-body">
            <h6>What's included in the backup:</h6>
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-primary">Database Records:</h6>
                    <ul>
                        <li>Admin users and settings</li>
                        <li>Advertisements and payment details</li>
                        <li>Tutorials and completions</li>
                        <li>App metadata and build jobs</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-primary">Files and Assets:</h6>
                    <ul>
                        <li>Generated package files</li>
                        <li>Static assets (CSS, JS, images)</li>
                        <li>HTML templates</li>
                        <li>Configuration files</li>
                    </ul>
                </div>
            </div>
            
            <hr>
            
            <h6>Best Practices:</h6>
            <ul>
                <li><strong>Regular Backups:</strong> Create backups regularly, especially before major changes</li>
                <li><strong>Secure Storage:</strong> Store backup files in a secure location outside the server</li>
                <li><strong>Test Restores:</strong> Periodically test backup restoration on a test environment</li>
                <li><strong>Version Control:</strong> Keep multiple backup versions with clear naming conventions</li>
            </ul>
            
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Important:</strong> After restoring a backup, you may need to restart the application for all changes to take effect.
            </div>
        </div>
    </div>
</div>

<script>
function showBackupProgress(form) {
    const btn = document.getElementById('backupBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Backup...';
    btn.disabled = true;
    
    // Re-enable button after a timeout in case of error
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-download me-2"></i>Create Full Backup';
        btn.disabled = false;
    }, 30000);
}

function confirmRestore(form) {
    const fileInput = document.getElementById('backup_file');
    const checkbox = document.getElementById('confirm_restore');
    
    if (!fileInput.files.length) {
        alert('Please select a backup file.');
        return false;
    }
    
    if (!checkbox.checked) {
        alert('Please confirm that you understand the risks of restoring a backup.');
        return false;
    }
    
    const confirmMsg = 'Are you absolutely sure you want to restore from this backup?\n\n' +
                      'This will PERMANENTLY DELETE all current data and replace it with the backup data.\n\n' +
                      'This action CANNOT be undone!\n\n' +
                      'Click OK to continue or Cancel to abort.';
    
    if (!confirm(confirmMsg)) {
        return false;
    }
    
    const btn = document.getElementById('restoreBtn');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Restoring...';
    btn.disabled = true;
    
    return true;
}
</script>
{% endblock %}
