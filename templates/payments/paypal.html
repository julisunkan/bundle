{% extends "base.html" %}

{% block title %}PayPal Payment - DigitalSkeleton{% endblock %}

{% block content %}
<div class="container">
    <h1>Complete Payment</h1>
    
    <div class="card mb-4">
        <div class="card-body">
            <h3>{{ course.title }}</h3>
            <p class="lead">Amount: ${{ amount }}</p>
            <p class="text-muted">Payment Reference: {{ reference }}</p>
        </div>
    </div>

    <div class="alert alert-info">
        <strong>Secure Payment with PayPal</strong>
        <p>You will be redirected to PayPal to complete your payment securely.</p>
    </div>

    <div id="paypal-button-container"></div>

    <div class="mt-3">
        <a href="{{ url_for('main.course_detail', course_id=course.id) }}" class="btn btn-secondary">Cancel</a>
    </div>
</div>

<script src="https://www.paypal.com/sdk/js?client-id={{ client_id }}&currency={{ currency }}"></script>
<script>
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    description: '{{ course.title }}',
                    amount: {
                        value: '{{ amount }}'
                    }
                }]
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                // Send payment verification to backend
                return fetch('{{ url_for("payments.paypal_callback") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderID: data.orderID,
                        paymentID: {{ payment_id }}
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Payment completed successfully!');
                        window.location.href = data.redirect_url;
                    } else {
                        alert('Payment verification failed: ' + data.message);
                        window.location.href = '{{ url_for("main.index") }}';
                    }
                })
                .catch(error => {
                    alert('Error processing payment: ' + error);
                    window.location.href = '{{ url_for("main.index") }}';
                });
            });
        },
        onError: function(err) {
            console.error('PayPal error:', err);
            alert('An error occurred during payment. Please try again.');
            window.location.href = '{{ url_for("main.course_detail", course_id=course.id) }}';
        },
        onCancel: function(data) {
            alert('Payment cancelled');
            window.location.href = '{{ url_for("main.course_detail", course_id=course.id) }}';
        }
    }).render('#paypal-button-container');
</script>
{% endblock %}
