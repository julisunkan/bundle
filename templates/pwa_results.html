{% extends "base.html" %}

{% block title %}PWA Files Generated - PWA Builder{% endblock %}

{% block content %}
<style>
/* Consistent dark theme matching index page */
body {
    background-color: #121212 !important;
}

.container {
    background-color: transparent !important;
}

/* Darker card backgrounds */
.card {
    background-color: #1e1e1e !important;
    border: 1px solid #333333 !important;
    color: #ffffff !important;
}

.card-header {
    background-color: #2a2a2a !important;
    border-bottom: 1px solid #333333 !important;
    color: #ffffff !important;
}

.card-body {
    background-color: #1e1e1e !important;
    color: #ffffff !important;
}

/* PWA file cards - much darker */
.pwa-file-card {
    background-color: #1a1a1a !important;
    border: 1px solid #333333 !important;
    color: #ffffff !important;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.pwa-file-card:hover {
    background-color: #252525 !important;
    transform: translateY(-1px);
    border-color: #444444 !important;
}

.pwa-file-title {
    color: #ffffff !important;
    font-weight: 600;
    margin-bottom: 4px;
}

.pwa-file-desc {
    color: #b0b0b0 !important;
    font-size: 0.875rem;
}

.pwa-file-size {
    color: #888888 !important;
    font-size: 0.75rem;
}

/* Headers and text */
h1, h2, h3, h4, h5, h6 {
    color: #ffffff !important;
}

.text-muted {
    color: #b0b0b0 !important;
}

p {
    color: #e0e0e0 !important;
}

/* Progress bar darker */
.progress {
    background-color: #2a2a2a !important;
}

/* Buttons */
.btn-outline-secondary {
    color: #b0b0b0 !important;
    border-color: #555555 !important;
}

.btn-outline-secondary:hover {
    background-color: #555555 !important;
    color: #ffffff !important;
    border-color: #666666 !important;
}

.btn-outline-primary {
    color: #4dabf7 !important;
    border-color: #4dabf7 !important;
}

.btn-outline-primary:hover {
    background-color: #4dabf7 !important;
    color: #ffffff !important;
}

/* Modal styling */
.modal-content {
    background-color: #1e1e1e !important;
    border: 1px solid #333333 !important;
    color: #ffffff !important;
}

.modal-header, .modal-footer {
    border-color: #333333 !important;
    background-color: #2a2a2a !important;
}

/* Code blocks */
pre {
    background-color: #0d1117 !important;
    color: #e6edf3 !important;
    border: 1px solid #333333 !important;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
}

/* Score display */
.display-4 {
    color: #4dabf7 !important;
}
</style>
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center mb-3">
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left me-2"></i>Back
                </a>
                <div>
                    <h1 class="h3 mb-1">PWA Files Generated</h1>
                    <p class="text-muted mb-0">{{ app_name }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PWA Assessment Results -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        PWA Readiness Assessment
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="text-center mb-3">
                                <div class="display-4 fw-bold text-primary">{{ pwa_score }}%</div>
                                <p class="text-muted">PWA Readiness Score</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar bg-{{ 'success' if pwa_score >= 80 else 'warning' if pwa_score >= 50 else 'danger' }}" 
                                     role="progressbar" 
                                     style="width: {{ pwa_score }}%"
                                     aria-valuenow="{{ pwa_score }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ pwa_score }}%
                                </div>
                            </div>
                            <p class="small text-muted">
                                {% if pwa_score >= 80 %}
                                    <i class="fas fa-check text-success"></i> Ready for PWA conversion
                                {% elif pwa_score >= 50 %}
                                    <i class="fas fa-exclamation-triangle text-warning"></i> Partially ready
                                {% else %}
                                    <i class="fas fa-times text-danger"></i> Needs improvement
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generated Files -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-file-code text-success me-2"></i>
                        Generated PWA Files
                    </h5>
                    <button class="btn btn-outline-primary btn-sm" onclick="downloadAllFiles()">
                        <i class="fas fa-download me-2"></i>Download All
                    </button>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% for filename, content in pwa_files.items() %}
                        <div class="col-md-6">
                            <div class="pwa-file-card h-100 p-3">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="pwa-file-title">
                                            <i class="fas fa-{{ 'cog' if 'sw.js' in filename else 'code' if '.html' in filename else 'file-alt' if '.md' in filename else 'file-code' }} me-2 text-primary"></i>
                                            {{ filename }}
                                        </div>
                                        <div class="pwa-file-desc">
                                            {% if 'manifest.json' in filename %}
                                                Web App Manifest
                                            {% elif 'sw.js' in filename %}
                                                Service Worker
                                            {% elif 'index.html' in filename %}
                                                Enhanced HTML
                                            {% elif 'offline.html' in filename %}
                                                Offline Page
                                            {% elif '.md' in filename %}
                                                Setup Instructions
                                            {% else %}
                                                PWA File
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary btn-sm" 
                                                onclick="viewFileContent('{{ filename }}', {{ content|tojson|safe }})"
                                                data-bs-toggle="tooltip" 
                                                title="View Content">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <a class="btn btn-outline-primary btn-sm" 
                                           href="{{ url_for('download_pwa_file', job_id=job_id, filename=filename) }}"
                                           data-bs-toggle="tooltip" 
                                           title="Download File">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </div>
                                </div>
                                <div class="pwa-file-size">
                                    Size: {{ (content|length / 1024)|round(1) }} KB
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Setup Guide -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-rocket text-warning me-2"></i>
                        Quick Setup Guide
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>1. Upload Files</h6>
                            <p class="small text-muted">Upload all generated files to your website's root directory.</p>
                        </div>
                        <div class="col-md-6">
                            <h6>2. Add Icons</h6>
                            <p class="small text-muted">Create app icons in various sizes (192x192, 512x512, etc.)</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>3. Test Installation</h6>
                            <p class="small text-muted">Visit your website and check for the "Install App" prompt.</p>
                        </div>
                        <div class="col-md-6">
                            <h6>4. Read Full Instructions</h6>
                            <p class="small text-muted">Download the setup instructions file for detailed steps.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Content Modal -->
<div class="modal fade" id="fileContentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom-color: #495057 !important;">
                <h5 class="modal-title" id="fileModalTitle" style="color: #ffffff !important;">File Content</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-end mb-3">
                    <button class="btn btn-sm btn-outline-secondary" onclick="copyFileContent()">
                        <i class="fas fa-copy me-1"></i>Copy
                    </button>
                </div>
                <pre id="fileContentPre" style="max-height: 400px; overflow-y: auto; background-color: #1e1e1e !important; color: #d4d4d4 !important; border: 1px solid #495057 !important; padding: 1rem; border-radius: 6px;"><code id="fileContent"></code></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentFileContent = '';

function downloadFile(filename, content) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function downloadAllFiles() {
    const files = {{ pwa_files|tojson|safe }};
    Object.keys(files).forEach(filename => {
        setTimeout(() => downloadFile(filename, files[filename]), 100);
    });
}

function viewFileContent(filename, content) {
    console.log('Opening modal for:', filename);
    currentFileContent = content;
    document.getElementById('fileModalTitle').textContent = filename;
    document.getElementById('fileContent').textContent = content;
    
    // Syntax highlighting based on file type
    const codeElement = document.getElementById('fileContent');
    if (filename.endsWith('.json')) {
        codeElement.className = 'language-json';
    } else if (filename.endsWith('.js')) {
        codeElement.className = 'language-javascript';
    } else if (filename.endsWith('.html')) {
        codeElement.className = 'language-html';
    } else if (filename.endsWith('.md')) {
        codeElement.className = 'language-markdown';
    } else {
        codeElement.className = 'language-text';
    }
    
    // Try different ways to show the modal
    try {
        const modalElement = document.getElementById('fileContentModal');
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            new bootstrap.Modal(modalElement).show();
        } else {
            // Fallback - show modal using jQuery if Bootstrap 5 isn't available
            if (typeof $ !== 'undefined') {
                $('#fileContentModal').modal('show');
            } else {
                // Manual fallback
                modalElement.style.display = 'block';
                modalElement.classList.add('show');
                document.body.classList.add('modal-open');
            }
        }
    } catch (error) {
        console.error('Error showing modal:', error);
        // Fallback - show content in alert
        alert(filename + '\n\n' + content);
    }
}

function copyFileContent() {
    navigator.clipboard.writeText(currentFileContent).then(() => {
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}