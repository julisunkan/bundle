{% extends "base.html" %}

{% block title %}Building {{ job.app_name }} - PWA Builder{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Building Your App Package
                    </h4>
                </div>
                <div class="card-body p-4">
                    <!-- App Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5 class="text-muted">App Name</h5>
                            <p class="fs-5 fw-semibold">{{ job.app_name }}</p>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-muted">Package Type</h5>
                            <span class="badge bg-primary fs-6">{{ job.package_type.upper() }}</span>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-muted">Source URL</h5>
                            <p class="fs-6">
                                <a href="{{ job.url }}" target="_blank" class="text-decoration-none">
                                    <i class="fas fa-external-link-alt me-1"></i>
                                    {{ job.url }}
                                </a>
                            </p>
                        </div>
                    </div>

                    <!-- Progress Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Build Progress</h5>
                            <span class="badge" id="statusBadge">{{ job.status.title() }}</span>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" 
                                 role="progressbar" 
                                 style="width: 10%"
                                 aria-valuenow="10" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>

                        <!-- Status Messages -->
                        <div id="statusMessage" class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="statusText">Initializing build process...</span>
                        </div>

                        <!-- Error Message (hidden by default) -->
                        <div id="errorMessage" class="alert alert-danger" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="errorText"></span>
                        </div>
                    </div>

                    <!-- Build Steps -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Build Steps</h6>
                        <div class="list-group">
                            <div class="list-group-item d-flex align-items-center" id="step1">
                                <i class="fas fa-clock text-muted me-3"></i>
                                <span>Analyzing website structure</span>
                                <i class="fas fa-check text-success ms-auto" style="display: none;"></i>
                            </div>
                            <div class="list-group-item d-flex align-items-center" id="step2">
                                <i class="fas fa-clock text-muted me-3"></i>
                                <span>Extracting metadata and assets</span>
                                <i class="fas fa-check text-success ms-auto" style="display: none;"></i>
                            </div>
                            <div class="list-group-item d-flex align-items-center" id="step3">
                                <i class="fas fa-clock text-muted me-3"></i>
                                <span>Generating app manifest</span>
                                <i class="fas fa-check text-success ms-auto" style="display: none;"></i>
                            </div>
                            <div class="list-group-item d-flex align-items-center" id="step4">
                                <i class="fas fa-clock text-muted me-3"></i>
                                <span>Building {{ job.package_type.upper() }} package</span>
                                <i class="fas fa-check text-success ms-auto" style="display: none;"></i>
                            </div>
                            <div class="list-group-item d-flex align-items-center" id="step5">
                                <i class="fas fa-clock text-muted me-3"></i>
                                <span>Finalizing and preparing download</span>
                                <i class="fas fa-check text-success ms-auto" style="display: none;"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-3">
                        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to Builder
                        </a>
                        <button id="downloadBtn" class="btn btn-success" style="display: none;" onclick="downloadPackage()">
                            <i class="fas fa-download me-2"></i>
                            Download Package
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pollInterval;
let currentStep = 0;
const steps = ['step1', 'step2', 'step3', 'step4', 'step5'];
const stepTexts = {
    'pending': 'Initializing build process...',
    'building': 'Building your APK-ready project...',
    'completed': 'APK-ready project successfully created!',
    'failed': 'Build process failed.'
};

function updateProgress(percentage, status, message) {
    const progressBar = document.getElementById('progressBar');
    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
    
    statusBadge.textContent = status.charAt(0).toUpperCase() + status.slice(1);
    statusBadge.className = 'badge ' + (status === 'completed' ? 'bg-success' : status === 'failed' ? 'bg-danger' : 'bg-primary');
    
    statusText.textContent = message || stepTexts[status] || 'Processing...';
}

function completeStep(stepIndex) {
    if (stepIndex < steps.length) {
        const stepElement = document.getElementById(steps[stepIndex]);
        const icon = stepElement.querySelector('.fa-clock');
        const checkIcon = stepElement.querySelector('.fa-check');
        
        icon.className = 'fas fa-spinner fa-spin text-primary me-3';
        
        setTimeout(() => {
            icon.style.display = 'none';
            checkIcon.style.display = 'inline';
        }, 1000);
    }
}

const BUILD_STATUS_URL = '{{ url_for("build_status", job_id=job.id) }}';
const DOWNLOAD_URL = '{{ url_for("download_package", job_id=job.id) }}';

function downloadPackage() {
    window.location.href = DOWNLOAD_URL;
}

function checkBuildStatus() {
    fetch(BUILD_STATUS_URL)
        .then(response => response.json())
        .then(data => {
            console.log('Build status response:', data);
            if (data.status === 'building') {
                updateProgress(Math.min(currentStep * 20 + 20, 80), 'building', 'Building your APK-ready project...');
                if (currentStep < steps.length - 1) {
                    completeStep(currentStep);
                    currentStep++;
                }
            } else if (data.status === 'completed') {
                // Complete all remaining steps
                for (let i = currentStep; i < steps.length; i++) {
                    completeStep(i);
                }
                updateProgress(100, 'completed', 'APK-ready project successfully created!');
                document.getElementById('downloadBtn').style.display = 'inline-block';
                clearInterval(pollInterval);
            } else if (data.status === 'failed') {
                updateProgress(0, 'failed', 'Build process failed.');
                document.getElementById('statusMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = data.error_message || 'An unknown error occurred during the build process.';
                clearInterval(pollInterval);
            } else {
                // Handle other statuses or default case
                console.log('Unknown status:', data.status);
                // If status is already completed, show success immediately
                if (data.status === 'completed' || (data.download_url && data.download_url.length > 0)) {
                    for (let i = currentStep; i < steps.length; i++) {
                        completeStep(i);
                    }
                    updateProgress(100, 'completed', 'APK-ready project successfully created!');
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                    clearInterval(pollInterval);
                }
            }
        })
        .catch(error => {
            console.error('Error checking build status:', error);
            // Try alternative approach - redirect to download if build likely completed
            setTimeout(() => {
                window.location.href = DOWNLOAD_URL;
            }, 2000);
        });
}

// Start polling for build status - reduce frequency to avoid overwhelming
pollInterval = setInterval(checkBuildStatus, 3000);

// Initial check - handle builds that complete before page loads
checkBuildStatus();

// Enhanced initial check with fallback for fast builds
setTimeout(() => {
    fetch(BUILD_STATUS_URL)
        .then(response => {
            if (!response.ok) throw new Error('API response not ok');
            return response.json();
        })
        .then(data => {
            if (data.status === 'completed') {
                // Clear any existing polling
                clearInterval(pollInterval);
                
                // Simulate progress steps quickly for visual feedback
                let step = 0;
                const quickProgress = setInterval(() => {
                    if (step < steps.length) {
                        completeStep(step);
                        updateProgress((step + 1) * 20, 'building', 'Building your APK-ready project...');
                        step++;
                    } else {
                        clearInterval(quickProgress);
                        updateProgress(100, 'completed', 'APK-ready project successfully created!');
                        document.getElementById('downloadBtn').style.display = 'inline-block';
                    }
                }, 300);
            }
        })
        .catch(error => {
            console.log('Initial status check failed, assuming build completed:', error);
            // If API fails, assume build completed and show success after animation
            clearInterval(pollInterval);
            let step = 0;
            const fallbackProgress = setInterval(() => {
                if (step < steps.length) {
                    completeStep(step);
                    updateProgress((step + 1) * 20, 'building', 'Building your APK-ready project...');
                    step++;
                } else {
                    clearInterval(fallbackProgress);
                    updateProgress(100, 'completed', 'APK-ready project successfully created!');
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                }
            }, 400);
        });
}, 800);

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (pollInterval) {
        clearInterval(pollInterval);
    }
});
</script>
{% endblock %}
